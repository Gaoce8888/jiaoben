#!/bin/bash

# --------------------------
# å“ç‰ŒLogoå±•ç¤ºå‡½æ•°
# --------------------------
show_logo() {
    clear
    echo -e "\033[1;36m
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—
    â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘
    â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘
    â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•      â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘
    â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
    â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â•â•šâ•â•â•â•â•â•â•    â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•
    \033[0m
    \033[32mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     gaoce.ai æç®€AI \033[1;33mQQ: 260060440\033[0m
    \033[32mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m
    "
}

# --------------------------
# å¯ç¼–è¾‘é…ç½®åŒº
# --------------------------
MODEL_DIR="./modelscope_models"  # æ¨¡å‹å­˜å‚¨ç›®å½•

# æ¨¡å‹æ¸…å•ï¼ˆåç§°|æ¨¡å‹ID|æ–‡ä»¶è·¯å¾„|SHA256æ ¡éªŒç ï¼‰
MODEL_LIST=(
    "BERTä¸­æ–‡æ¨¡å‹|damo/nlp_bert_word-segmentation_chinese-base|pytorch_model.bin|a1b2c3d4..."
    "YOLOv6ç›®æ ‡æ£€æµ‹|damo/cv_yolov6_object-detection_keypoints|yolov6s.pt|e5f6g7h8..."
    "è¯­éŸ³è¯†åˆ«æ¨¡å‹|damo/speech_paraformer-large_asr_nat-zh-cn|model.pb|i9j0k1l2..."
)

# --------------------------
# åŠŸèƒ½å‡½æ•°
# --------------------------
# å¸¦é¢œè‰²è¾“å‡º
color_echo() {
    echo -e "\033[$1m$2\033[0m"
}

# åŠ¨æ€è¿›åº¦æ¡
progress_bar() {
    local pid=$1
    local delay=0.5
    local spin=('â ‹' 'â ™' 'â ¹' 'â ¸' 'â ¼' 'â ´' 'â ¦' 'â §' 'â ‡' 'â ')
    
    while kill -0 $pid 2>/dev/null; do
        for i in "${spin[@]}"; do
            printf "\r[%s] ä¸‹è½½ä¸­..." "$i"
            sleep $delay
        done
    done
    printf "\r\033[K[âœ”] ä¸‹è½½å®Œæˆ\n"
}

# æ–‡ä»¶æ ¡éªŒ
verify_hash() {
    local file_hash=$(sha256sum "$1" | awk '{print $1}')
    [[ "$file_hash" == "$2" ]]
}

# --------------------------
# ä¸»ç¨‹åºé€»è¾‘
# --------------------------
show_logo  # æ˜¾ç¤ºå“ç‰ŒLogo

# æ˜¾ç¤ºæ¨¡å‹èœå•
color_echo "36" "\nğŸ›’ å¯ç”¨æ¨¡å‹åˆ—è¡¨ï¼š"
for idx in "${!MODEL_LIST[@]}"; do
    IFS='|' read -r name id _ _ <<< "${MODEL_LIST[$idx]}"
    printf "  \033[1;35m%2d)\033[0m %-28s \033[2m(ID: %s)\033[0m\n" $((idx+1)) "$name" "$id"
done

# ç”¨æˆ·è¾“å…¥å¤„ç†
echo -e "\n\033[1;32mâŒ¨ è¾“å…¥é€‰é¡¹ï¼ˆå¤šä¸ªç”¨ç©ºæ ¼åˆ†éš”ï¼Œ0é€€å‡ºï¼Œaå…¨é€‰ï¼‰:\033[0m"
read -p "> " choices

# é€€å‡ºå¤„ç†
[[ "$choices" == "0" ]] && exit 0

# åˆ›å»ºå­˜å‚¨ç›®å½•
mkdir -p "$MODEL_DIR" || { color_echo "31" "âŒ ç›®å½•åˆ›å»ºå¤±è´¥"; exit 1; }

# å¤„ç†å…¨é€‰
if [[ "$choices" == "a" ]]; then
    selected=($(seq 1 ${#MODEL_LIST[@]}))
else
    selected=($choices)
fi

# ä¸‹è½½ä¸»å¾ªç¯
for input in "${selected[@]}"; do
    # è¾“å…¥éªŒè¯
    if ! [[ "$input" =~ ^[0-9]+$ ]] || ((input < 1 || input > ${#MODEL_LIST[@]})); then
        color_echo "31" "âš  æ— æ•ˆé€‰é¡¹: $input"
        continue
    fi

    # è§£æé…ç½®
    idx=$((input-1))
    IFS='|' read -r name model_id file_path expect_hash <<< "${MODEL_LIST[$idx]}"
    save_name="${model_id//\//_}_${file_path}"  # å¤„ç†ç‰¹æ®Šå­—ç¬¦
    save_path="${MODEL_DIR}/${save_name}"
    model_url="https://modelscope.cn/api/v1/models/${model_id}/repo?Revision=master&FilePath=${file_path}"

    # æ–‡ä»¶æ ¡éªŒ
    if [[ -f "$save_path" ]]; then
        if verify_hash "$save_path" "$expect_hash"; then
            color_echo "32" "âœ… [$name] æ–‡ä»¶å·²å­˜åœ¨ä¸”é€šè¿‡æ ¡éªŒ"
            continue
        else
            color_echo "33" "ğŸ”„ [$name] æ–‡ä»¶æ ¡éªŒå¤±è´¥ï¼Œé‡æ–°ä¸‹è½½..."
            rm -f "$save_path"
        fi
    fi

    # ä¸‹è½½æ‰§è¡Œ
    color_echo "36" "ğŸš€ å¼€å§‹ä¸‹è½½: \033[1;37m${name}\033[0m"
    (wget -c -q --show-progress -O "$save_path" "$model_url" 2>&1 &)
    progress_bar $!

    # æœ€ç»ˆæ ¡éªŒ
    if verify_hash "$save_path" "$expect_hash"; then
        color_echo "32" "âœ… [$name] ä¸‹è½½æ ¡éªŒé€šè¿‡"
    else
        color_echo "31" "âŒ [$name] æ–‡ä»¶æŸåï¼å·²åˆ é™¤æ— æ•ˆæ–‡ä»¶"
        rm -f "$save_path"
    fi
done

# ç»“æŸæç¤º
echo -e "\n\033[32mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 æ„Ÿè°¢ä½¿ç”¨ï¼é‡åˆ°é—®é¢˜è¯·è”ç³»ï¼š
 \033[1;33mQQ: 260060440\033[0m
\033[32mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m\n"